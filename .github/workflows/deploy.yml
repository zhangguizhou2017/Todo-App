name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # 2. è®¾ç½® Node.js ç¯å¢ƒ
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # 3. å®‰è£…ä¾èµ–å¹¶æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    # 4. è°ƒè¯• - éªŒè¯ Secrets æ˜¯å¦å¯ç”¨
    - name: è°ƒè¯• - éªŒè¯ GitHub Secrets
      run: |
        echo "=== è°ƒè¯• GitHub Secrets ==="
        echo "SERVER_HOST é•¿åº¦: ${#SERVER_HOST}"
        echo "SERVER_USER é•¿åº¦: ${#SERVER_USER}" 
        echo "SERVER_PORT é•¿åº¦: ${#SERVER_PORT}"
        echo "SERVER_SSH_KEY é•¿åº¦: ${#SERVER_SSH_KEY}"
        echo "SERVER_HOST å‰10ä¸ªå­—ç¬¦: ${SERVER_HOST:0:10}"
        echo "SERVER_USER å†…å®¹: ${SERVER_USER}"
        echo "SERVER_PORT å†…å®¹: ${SERVER_PORT}"
        echo "æµ‹è¯•å˜é‡ REPO_NAME: ${REPO_NAME}"
        echo "æµ‹è¯•å˜é‡ RUNNER_USER: ${RUNNER_USER}"
        echo "æµ‹è¯•å˜é‡ TEST_HOST: ${TEST_HOST}"
        if [ -n "$SERVER_HOST" ]; then
          echo "âœ… SERVER_HOST å¯ç”¨"
        else
          echo "âŒ SERVER_HOST ä¸ºç©ºæˆ–æœªå®šä¹‰"
        fi
        if [ -n "$SERVER_SSH_KEY" ]; then
          echo "âœ… SERVER_SSH_KEY å¯ç”¨"
        else
          echo "âŒ SERVER_SSH_KEY ä¸ºç©ºæˆ–æœªå®šä¹‰"
        fi
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PORT: ${{ secrets.SERVER_PORT }}
        SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        # æµ‹è¯•ç”¨å˜é‡
        TEST_HOST: ${{ vars.TEST_HOST }}
        REPO_NAME: ${{ github.repository }}
        RUNNER_USER: ${{ github.actor }}
    
    # 5. ä¸´æ—¶æµ‹è¯• - ä½¿ç”¨ç¡¬ç¼–ç è¿æ¥
    - name: ä¸´æ—¶æµ‹è¯• SSH è¿æ¥ï¼ˆç¡¬ç¼–ç ï¼‰
      run: |
        echo "=== ä¸´æ—¶è·³è¿‡ SSH éƒ¨ç½²ï¼Œç­‰å¾…ä¿®å¤ Secrets é—®é¢˜ ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "ç”¨æˆ·: ${{ github.actor }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo ""
        echo "ğŸ“‹ éœ€è¦ä¿®å¤çš„é—®é¢˜:"
        echo "1. GitHub Repository Secrets æ— æ³•è¯»å–"
        echo "2. éœ€è¦é‡æ–°é…ç½®æ‰€æœ‰ Secrets"
        echo "3. æ£€æŸ¥ä»“åº“æƒé™è®¾ç½®"
        
    # 5. éƒ¨ç½²åˆ°æœåŠ¡å™¨ (æš‚æ—¶ç¦ç”¨)
    # - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    #   uses: appleboy/ssh-action@v1.0.3
    #   with:
    #     host: ${{ secrets.SERVER_HOST }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY }}
    #     port: ${{ secrets.SERVER_PORT }}
    #     debug: true
    #     timeout: 30s
    #     command_timeout: 10m
    #     script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /www/wwwroot/todo-app
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main
          
          # å®‰è£…/æ›´æ–°ä¾èµ–
          npm ci --production
          
          # å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # é‡å¯ PM2 è¿›ç¨‹
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # æ˜¾ç¤ºçŠ¶æ€
          pm2 status
          pm2 logs todo-app --lines 10