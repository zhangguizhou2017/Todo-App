name: ç®€åŒ–è‡ªåŠ¨éƒ¨ç½²

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ç›´æ¥è¿›è¡Œ SSH éƒ¨ç½²ï¼Œè·³è¿‡æ‰€æœ‰å¯èƒ½å¡ä½çš„æ­¥éª¤
    - name: SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 30s
        command_timeout: 5m
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /www/wwwroot/todo-app
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“‹ å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main
          
          # å®‰è£…/æ›´æ–°ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ä¸»åº”ç”¨ä¾èµ–..."
          npm ci --production
          
          # å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–
          echo "ğŸ“¦ å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–..."
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # é‡å¯ PM2 è¿›ç¨‹
          echo "ğŸ”„ é‡å¯åº”ç”¨..."
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          pm2 status
          echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—:"
          pm2 logs todo-app --lines 5