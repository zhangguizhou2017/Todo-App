name: ç®€åŒ–è‡ªåŠ¨éƒ¨ç½²

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ç›´æ¥è¿›è¡Œ SSH éƒ¨ç½²ï¼Œè·³è¿‡æ‰€æœ‰å¯èƒ½å¡ä½çš„æ­¥éª¤
    - name: SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 30s
        command_timeout: 5m
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          echo "ğŸ—‘ï¸ æ¸…ç†æ—§ç‰ˆæœ¬..."
          if [ -d "/www/wwwroot/todo-app" ]; then
            echo "åˆ é™¤æ—§é¡¹ç›®ç›®å½•..."
            rm -rf /www/wwwroot/todo-app
          fi
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•
          echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•..."
          mkdir -p /www/wwwroot
          
          # å…‹éš†æœ€æ–°ä»£ç 
          echo "ğŸ“¥ å…‹éš†æœ€æ–°ä»£ç ..."
          cd /www/wwwroot
          git clone https://github.com/zhangguizhou2017/Todo-App.git todo-app
          cd todo-app
          
          # å®‰è£…/æ›´æ–°ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ä¸»åº”ç”¨ä¾èµ–..."
          npm ci --production
          
          # å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–
          echo "ğŸ“¦ å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–..."
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # é‡å¯ PM2 è¿›ç¨‹
          echo "ğŸ”„ é‡å¯åº”ç”¨..."
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          pm2 status
          echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—:"
          pm2 logs todo-app --lines 5