name: 自动部署到服务器

# 触发条件：当推送到 main 分支时
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: 检出代码
      uses: actions/checkout@v4
    
    # 2. 设置 Node.js 环境
    - name: 设置 Node.js 环境
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # 3. 安装依赖并测试（可选）
    - name: 安装依赖
      run: npm ci
    
    # 4. 调试 - 验证 Secrets 是否可用
    - name: 调试 - 验证 GitHub Secrets
      run: |
        echo "=== 调试 GitHub Secrets ==="
        echo "SERVER_HOST 长度: ${#SERVER_HOST}"
        echo "SERVER_USER 长度: ${#SERVER_USER}" 
        echo "SERVER_PORT 长度: ${#SERVER_PORT}"
        echo "SERVER_SSH_KEY 长度: ${#SERVER_SSH_KEY}"
        echo "SERVER_HOST 前10个字符: ${SERVER_HOST:0:10}"
        echo "SERVER_USER 内容: ${SERVER_USER}"
        echo "SERVER_PORT 内容: ${SERVER_PORT}"
        if [ -n "$SERVER_HOST" ]; then
          echo "✅ SERVER_HOST 可用"
        else
          echo "❌ SERVER_HOST 为空或未定义"
        fi
        if [ -n "$SERVER_SSH_KEY" ]; then
          echo "✅ SERVER_SSH_KEY 可用"
        else
          echo "❌ SERVER_SSH_KEY 为空或未定义"
        fi
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PORT: ${{ secrets.SERVER_PORT }}
        SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
    
    # 5. 部署到服务器
    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        debug: true
        timeout: 30s
        command_timeout: 10m
        script: |
          # 进入项目目录
          cd /www/wwwroot/todo-app
          
          # 拉取最新代码
          git pull origin main
          
          # 安装/更新依赖
          npm ci --production
          
          # 安装 MCP 服务器依赖
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # 重启 PM2 进程
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # 显示状态
          pm2 status
          pm2 logs todo-app --lines 10