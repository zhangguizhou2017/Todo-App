name: ç®€åŒ–è‡ªåŠ¨éƒ¨ç½²

# è§¦å‘æ¡ä»¶ï¼šå½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ç›´æŽ¥è¿›è¡Œ SSH éƒ¨ç½²ï¼Œè·³è¿‡æ‰€æœ‰å¯èƒ½å¡ä½çš„æ­¥éª¤
    - name: SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 30s
        command_timeout: 5m
        script: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          echo "ðŸ—‘ï¸ æ¸…ç†æ—§ç‰ˆæœ¬..."
          if [ -d "/www/wwwroot/todo-app" ]; then
            echo "åˆ é™¤æ—§é¡¹ç›®ç›®å½•..."
            rm -rf /www/wwwroot/todo-app
          fi
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•
          echo "ðŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•..."
          mkdir -p /www/wwwroot
          
          # å…‹éš†æœ€æ–°ä»£ç 
          echo "ðŸ“¥ å…‹éš†æœ€æ–°ä»£ç ..."
          cd /www/wwwroot
          git clone https://github.com/zhangguizhou2017/Todo-App.git todo-app
          cd todo-app
          
          # åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶
          echo "âš™ï¸ åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶..."
          cat > .env << EOF
          NODE_ENV=production
          
          # æ•°æ®åº“é…ç½®
          DB_HOST=localhost
          DB_PORT=3306
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=todoapp
          
          # API å¯†é’¥é…ç½®
          API_KEYS=${{ secrets.API_KEYS }}
          REQUIRE_AUTH=false
          
          # CORS é…ç½®
          ALLOWED_ORIGINS=*
          EOF
          
          # å®‰è£…/æ›´æ–°ä¾èµ–
          echo "ðŸ“¦ å®‰è£…ä¸»åº”ç”¨ä¾èµ–..."
          npm ci --production
          
          # å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–
          echo "ðŸ“¦ å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–..."
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # é‡å¯ PM2 è¿›ç¨‹
          echo "ðŸ”„ é‡å¯åº”ç”¨..."
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          pm2 status
          echo "ðŸ“‹ æœ€è¿‘æ—¥å¿—:"
          pm2 logs todo-app --lines 5