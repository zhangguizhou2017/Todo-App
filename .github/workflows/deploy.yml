name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # 2. è·³è¿‡ Node.js ç¯å¢ƒè®¾ç½® (æœåŠ¡å™¨ç«¯å·²æœ‰ Node.js)
    # - name: è®¾ç½® Node.js ç¯å¢ƒ
    #   uses: actions/setup-node@v4
    #   with:
    #     node-version: '18'
    #     cache: 'npm'
    
    # 3. è·³è¿‡æœ¬åœ°ä¾èµ–å®‰è£… (åœ¨æœåŠ¡å™¨ç«¯å®‰è£…)
    # - name: å®‰è£…ä¾èµ–
    #   run: npm ci
    
    # 4. éªŒè¯éƒ¨ç½²é…ç½®
    - name: éªŒè¯éƒ¨ç½²é…ç½®
      run: |
        echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        if [ -n "$SERVER_HOST" ] && [ -n "$SERVER_SSH_KEY" ]; then
          echo "âœ… éƒ¨ç½²é…ç½®éªŒè¯é€šè¿‡"
        else
          echo "âŒ éƒ¨ç½²é…ç½®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ Repository Secrets"
          exit 1
        fi
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
    
    # 5. éƒ¨ç½²åˆ°æœåŠ¡å™¨
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        debug: true
        timeout: 30s
        command_timeout: 10m
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /www/wwwroot/todo-app
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main
          
          # å®‰è£…/æ›´æ–°ä¾èµ–
          npm ci --production
          
          # å®‰è£… MCP æœåŠ¡å™¨ä¾èµ–
          cd todo-mcp-server
          npm ci --production
          cd ..
          
          # é‡å¯ PM2 è¿›ç¨‹
          pm2 restart todo-app || pm2 start server.js --name todo-app
          
          # æ˜¾ç¤ºçŠ¶æ€
          pm2 status
          pm2 logs todo-app --lines 10